!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("json"),require("top-domain")):"function"==typeof define&&define.amd?define(["json","top-domain"],e):t.rakam=e(t.JSON,t.topDomain)}(this,function(t,e){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,e=e&&e.hasOwnProperty("default")?e.default:e;var n,i={encode:function(t){for(var e="",n=0;n<t.length;n++){var i=t.charCodeAt(n);i<128?e+=String.fromCharCode(i):i>127&&i<2048?(e+=String.fromCharCode(i>>6|192),e+=String.fromCharCode(63&i|128)):(e+=String.fromCharCode(i>>12|224),e+=String.fromCharCode(i>>6&63|128),e+=String.fromCharCode(63&i|128))}return e},decode:function(t){for(var e="",n=0,i=0,o=0,s=0;n<t.length;)(i=t.charCodeAt(n))<128?(e+=String.fromCharCode(i),n++):i>191&&i<224?(o=t.charCodeAt(n+1),e+=String.fromCharCode((31&i)<<6|63&o),n+=2):(o=t.charCodeAt(n+1),s=t.charCodeAt(n+2),e+=String.fromCharCode((15&i)<<12|(63&o)<<6|63&s),n+=3);return e}},o={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){try{if(window.btoa&&window.atob)return window.btoa(unescape(encodeURIComponent(t)))}catch(t){}return o._encode(t)},_encode:function(t){var e,n,s,r,a,u,d,p="",l=0;for(t=i.encode(t);l<t.length;)r=(e=t.charCodeAt(l++))>>2,a=(3&e)<<4|(n=t.charCodeAt(l++))>>4,u=(15&n)<<2|(s=t.charCodeAt(l++))>>6,d=63&s,isNaN(n)?u=d=64:isNaN(s)&&(d=64),p=p+o._keyStr.charAt(r)+o._keyStr.charAt(a)+o._keyStr.charAt(u)+o._keyStr.charAt(d);return p},decode:function(t){try{if(window.btoa&&window.atob)return decodeURIComponent(escape(window.atob(t)))}catch(t){}return o._decode(t)},_decode:function(t){var e,n,s,r,a,u,d="",p=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");p<t.length;)e=o._keyStr.indexOf(t.charAt(p++))<<2|(r=o._keyStr.indexOf(t.charAt(p++)))>>4,n=(15&r)<<4|(a=o._keyStr.indexOf(t.charAt(p++)))>>2,s=(3&a)<<6|(u=o._keyStr.indexOf(t.charAt(p++))),d+=String.fromCharCode(e),64!==a&&(d+=String.fromCharCode(n)),64!==u&&(d+=String.fromCharCode(s));return d=i.decode(d)}},s=o,r={expirationDays:void 0,domain:void 0},a=function(t){var e="";return r.domain&&(e="."===r.domain.charAt(0)?r.domain.substring(1):r.domain),t+e},u=function(e){try{for(var n=a(e)+"=",i=document.cookie.split(";"),o=null,r=0;r<i.length;r++){for(var u=i[r];" "===u.charAt(0);)u=u.substring(1,u.length);if(0===u.indexOf(n)){o=u.substring(n.length,u.length);break}}return o?t.parse(s.decode(o)):null}catch(t){return null}},d=function(e,n){try{return p(a(e),s.encode(t.stringify(n)),r),!0}catch(t){return!1}},p=function(t,e,n){var i=null!==e?n.expirationDays:-1;if(i){var o=new Date;o.setTime(o.getTime()+24*i*60*60*1e3),i=o}var s=t+"="+e;i&&(s+="; expires="+i.toUTCString()),s+="; path=/",n.domain&&(s+="; domain="+n.domain),document.cookie=s},l=function(t){try{return p(a(t),null,r),!0}catch(t){return!1}},c={reset:function(){r={}},options:function(t){if(0===arguments.length)return r;t=t||{},r.expirationDays=t.expirationDays;var n=void 0!==t.domain?t.domain:"."+e(window.location.href),i=Math.random();r.domain=n,d("rakam_test",i);var o=u("rakam_test");o&&o===i||(n=null),l("rakam_test"),r.domain=n},get:u,set:d,remove:l},h={language:navigator&&(navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage)||void 0};if(function(){var t,e=new Date;try{return window.localStorage.setItem(e,e),t=window.localStorage.getItem(e)===String(e),window.localStorage.removeItem(e),t}catch(t){}return!1}())n=window.localStorage;else if(window.globalStorage)try{n=window.globalStorage[window.location.hostname]}catch(t){}else{var v=document.createElement("div"),f="localStorage";v.style.display="none",document.getElementsByTagName("head")[0].appendChild(v),v.addBehavior&&(v.addBehavior("#default#userdata"),n={length:0,setItem:function(t,e){v.load(f),v.getAttribute(t)||this.length++,v.setAttribute(t,e),v.save(f)},getItem:function(t){return v.load(f),v.getAttribute(t)},removeItem:function(t){v.load(f),v.getAttribute(t)&&this.length--,v.removeAttribute(t),v.save(f)},clear:function(){v.load(f);for(var t,e=0;t=v.XMLDocument.documentElement.attributes[e++];)v.removeAttribute(t.name);v.save(f),this.length=0},key:function(t){return v.load(f),v.XMLDocument.documentElement.attributes[t]}},v.load(f),n.length=v.XMLDocument.documentElement.attributes.length)}n||(n={length:0,setItem:function(t,e){},getItem:function(t){},removeItem:function(t){},clear:function(){},key:function(t){}});var m=n,g=function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},y=function(t,e,n){this.url=t,this.data=e||{},this.headers=n||{}};y.prototype.send=function(e){if(!!window.XDomainRequest){var n=new window.XDomainRequest;n.open("POST",this.url,!0),n.onload=function(){e(n.responseText)},n.send(t.stringify(this.data))}else{var i=new XMLHttpRequest;i.withCredentials="true",i.open("POST",this.url,!0),i.onreadystatechange=function(){4===i.readyState&&e(i.status,i.responseText,function(t){var e={};if(!t)return e;for(var n=t.split("\r\n"),i=0;i<n.length;i++){var o=n[i],s=o.indexOf(": ");if(s>0){var r=o.substring(0,s),a=o.substring(s+2);e[r]=a}}return e}(i.getAllResponseHeaders()))},i.setRequestHeader("Content-Type","text/plain");for(var o in this.headers)this.headers.hasOwnProperty(o)&&i.setRequestHeader(o,this.headers[o]);i.send(t.stringify(this.data))}};var _=y,w=function(t){return t?(t^16*Math.random()>>t/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,w)},I=w,b=Object.prototype.toString,E=function(t){switch(b.call(t)){case"[object Date]":return"date";case"[object RegExp]":return"regexp";case"[object Arguments]":return"arguments";case"[object Array]":return"array";case"[object Error]":return"error"}return null===t?"null":void 0===t?"undefined":t!=t?"nan":t&&1===t.nodeType?"element":"undefined"!=typeof Buffer&&Buffer.isBuffer(t)?"buffer":typeof(t=t.valueOf?t.valueOf():Object.prototype.valueOf.apply(t))},k=function(t,e,n){return function(t,e,i){void 0!==n&&n(t,e,i)}},C=function(t){return("https:"===window.location.protocol?"https":"http")+"://"+t.apiEndpoint+"/user"},T=function(){};T.prototype.init=function(t){this.options=t},T.prototype.set=function(t,e){return new _(C(this.options)+"/set_properties",{api:{api_version:1,api_key:this.options.apiKey},id:this.options.userId,properties:t}).send(k(0,0,e)),this},T.prototype._merge=function(t,e,n){return new _(C(this.options)+"/merge",{api:{api_version:1,api_key:this.options.apiKey,upload_time:(new Date).getTime()},anonymous_id:t,id:this.options.userId,created_at:e?e.getTime():null,merged_at:(new Date).getTime()}).send(k(0,0,n)),this},T.prototype.setOnce=function(t,e){return new _(C(this.options)+"/set_properties_once",{api:{api_version:1,api_key:this.options.apiKey},id:this.options.userId,properties:t}).send(k(0,0,e)),this},T.prototype.increment=function(t,e,n){return new _(C(this.options)+"/increment_property",{api:{api_version:1,api_key:this.options.apiKey},id:this.options.userId,property:t,value:e}).send(k(0,0,n)),this},T.prototype.unset=function(t,e){return new _(C(this.options)+"/unset_properties",{api:{api_version:1,api_key:this.options.apiKey},id:this.options.userId,properties:"array"===E(t)?t:[t]}).send(k(0,0,e)),this};var A=T,S="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},x=function(t,e){return e={exports:{}},t(e,e.exports),e.exports}(function(t,e){(function(){!function(e,n){t.exports=n()}(0,function(){var t,e,n,i,o,s,r,a,u,d,p,l,c;return a={},n=document,d=!1,p="active",s=6e4,o=!1,e=function(){var t,e,n,i,o;return i={},e="__ceGUID",t=function(t,n,o){return t[e]=void 0,t[e]||(t[e]="ifvisible.object.event.identifier"),i[t[e]]||(i[t[e]]={}),i[t[e]][n]||(i[t[e]][n]=[]),i[t[e]][n].push(o)},n=function(t,n,o){var s,r,a,u,d;if(t[e]&&i[t[e]]&&i[t[e]][n]){for(d=[],r=0,a=(u=i[t[e]][n]).length;r<a;r++)s=u[r],d.push(s(o||{}));return d}},o=function(t,n,o){var s,r,a,u,d;if(o){if(t[e]&&i[t[e]]&&i[t[e]][n])for(r=a=0,u=(d=i[t[e]][n]).length;a<u;r=++a)if((s=d[r])===o)return i[t[e]][n].splice(r,1),s}else if(t[e]&&i[t[e]]&&i[t[e]][n])return delete i[t[e]][n]},{add:t,remove:o,fire:n}}(),t=function(){var t;return t=!1,function(e,n,i){return t||(t=e.addEventListener?function(t,e,n){return t.addEventListener(e,n,!1)}:e.attachEvent?function(t,e,n){return t.attachEvent("on"+e,n,!1)}:function(t,e,n){return t["on"+e]=n}),t(e,n,i)}}(),r=function(){var t,e,i,o;for(void 0,o=3,i=n.createElement("div"),t=i.getElementsByTagName("i"),e=function(){return i.innerHTML="\x3c!--[if gt IE "+ ++o+"]><i></i><![endif]--\x3e",t[0]};e(););return o>4?o:void 0}(),i=!1,c=void 0,void 0!==n.hidden?(i="hidden",c="visibilitychange"):void 0!==n.mozHidden?(i="mozHidden",c="mozvisibilitychange"):void 0!==n.msHidden?(i="msHidden",c="msvisibilitychange"):void 0!==n.webkitHidden&&(i="webkitHidden",c="webkitvisibilitychange"),l=function(){var e,i;return e=!1,(i=function(){return clearTimeout(e),"active"!==p&&a.wakeup(),o=+new Date,e=setTimeout(function(){if("active"===p)return a.idle()},s)})(),t(n,"mousemove",i),t(n,"keyup",i),t(window,"scroll",i),a.focus(i),a.wakeup(i)},u=function(){var e;return!!d||(!1===i?(e="blur",r<9&&(e="focusout"),t(window,e,function(){return a.blur()}),t(window,"focus",function(){return a.focus()})):t(n,c,function(){return n[i]?a.blur():a.focus()},!1),d=!0,l())},a={setIdleDuration:function(t){return s=1e3*t},getIdleDuration:function(){return s},getIdleInfo:function(){var t,e;return t=+new Date,e={},"idle"===p?(e.isIdle=!0,e.idleFor=t-o,e.timeLeft=0,e.timeLeftPer=100):(e.isIdle=!1,e.idleFor=t-o,e.timeLeft=o+s-t,e.timeLeftPer=(100-100*e.timeLeft/s).toFixed(2)),e},focus:function(t){return"function"==typeof t?this.on("focus",t):(p="active",e.fire(this,"focus"),e.fire(this,"wakeup"),e.fire(this,"statusChanged",{status:p}))},blur:function(t){return"function"==typeof t?this.on("blur",t):(p="hidden",e.fire(this,"blur"),e.fire(this,"idle"),e.fire(this,"statusChanged",{status:p}))},idle:function(t){return"function"==typeof t?this.on("idle",t):(p="idle",e.fire(this,"idle"),e.fire(this,"statusChanged",{status:p}))},wakeup:function(t){return"function"==typeof t?this.on("wakeup",t):(p="active",e.fire(this,"wakeup"),e.fire(this,"statusChanged",{status:p}))},on:function(t,n){return u(),e.add(this,t,n)},off:function(t,n){return u(),e.remove(this,t,n)},onEvery:function(t,e){var n,i;return u(),n=!1,e&&(i=setInterval(function(){if("active"===p&&!1===n)return e()},1e3*t)),{stop:function(){return clearInterval(i)},pause:function(){return n=!0},resume:function(){return n=!1},code:i,callback:e}},now:function(t){return u(),p===(t||"active")}}})}).call(S)}),P=E,U={apiEndpoint:"app.rakam.io",eventEndpointPath:"/event/batch",cookieExpiration:3650,cookieName:"rakam_id",domain:void 0,includeUtm:!1,trackForms:!1,language:h.language,optOut:!1,platform:"Web",savedMaxCount:1e3,saveEvents:!0,sessionTimeout:18e5,unsentKey:"rakam_unsent",uploadBatchSize:100,batchEvents:!1,eventUploadThreshold:30,eventUploadPeriodMillis:3e4},O="rakam_lastEventId",D="rakam_lastEventTime",N="rakam_sessionId",M="rakam_returning",R=function(){this._unsentEvents=[],this.options=g({},U)};R.prototype._eventId=0,R.prototype._returningUser=!1,R.prototype._sending=!1,R.prototype._lastEventTime=null,R.prototype._sessionId=null,R.prototype._newSession=!1,R.prototype.log=function(t){!0===this.options.debug&&window.console&&window.console.log&&console.log("[Rakam] "+t)},R.prototype.init=function(e,n,i,o){try{if(!e)throw new Error("apiKey is null");this.options.apiKey=e;var s=new A;if(s.init(this.options),this.User=function(){return s},i&&(this.options.apiEndpoint=i.apiEndpoint||this.options.apiEndpoint,this.options.debug=i.debug||!0===this.options.debug,void 0!==i.saveEvents&&(this.options.saveEvents=!!i.saveEvents),void 0!==i.domain&&(this.options.domain=i.domain),void 0!==i.includeUtm&&(this.options.includeUtm=!!i.includeUtm),void 0!==i.trackClicks&&(this.options.trackClicks=!!i.trackClicks),void 0!==i.trackForms&&(this.options.trackForms=!!i.trackForms),void 0!==i.batchEvents&&(this.options.batchEvents=!!i.batchEvents),this.options.platform=i.platform||this.options.platform,this.options.language=i.language||this.options.language,this.options.sessionTimeout=i.sessionTimeout||this.options.sessionTimeout,this.options.uploadBatchSize=i.uploadBatchSize||this.options.uploadBatchSize,this.options.eventUploadThreshold=i.eventUploadThreshold||this.options.eventUploadThreshold,this.options.savedMaxCount=i.savedMaxCount||this.options.savedMaxCount,this.options.eventUploadPeriodMillis=i.eventUploadPeriodMillis||this.options.eventUploadPeriodMillis,this.options.superProperties=i.superProperties||[]),c.options({expirationDays:this.options.cookieExpiration,domain:this.options.domain}),this.options.domain=c.options().domain,z(this),i&&void 0!==i.deviceId&&null!==i.deviceId&&i.deviceId||this.options.deviceId?this.options.deviceId=this.options.deviceId:(this.deviceIdCreatedAt=new Date,this.options.deviceId=I()),K(this),this.log("initialized with apiKey="+e),this.options.saveEvents){var r=m.getItem(this.options.unsentKey);if(r)try{this._unsentEvents=t.parse(r)}catch(t){this.log(t)}}this._sendEventsIfReady(),this.options.includeUtm&&this._initUtmData(),this.options.trackForms&&this._initTrackForms(),this.options.trackClicks&&this._initTrackClicks(),this._lastEventTime=parseInt(m.getItem(D))||null,this._sessionId=parseInt(m.getItem(N))||null,this._eventId=m.getItem(O)||0;var a=(new Date).getTime();!this._sessionId||!this._lastEventTime||a-this._lastEventTime>this.options.sessionTimeout?(null!==this._sessionId&&(m.setItem(M,!0),this._returningUser=!0),this._sessionId=a,c.remove("_rakam_time"),m.setItem(N,this._sessionId)):this._returningUser="true"===m.getItem(M),this._lastEventTime=a,m.setItem(D,this._lastEventTime)}catch(t){this.log(t)}this.setUserId(n),o&&"function"==typeof o&&setTimeout(function(){o()},1)},R.prototype.onEvent=function(t){this.options.eventCallbacks=this.options.eventCallbacks||[],this.options.eventCallbacks.push(t)};var q=function(t,e,n,i){return null!==i&&(i=i.toLowerCase()),"long"===i||"time"===i||"timestamp"===i||"date"===i?(n=parseInt(n),!isNaN(n)&&isFinite(n)||(t.log("ignoring "+e+": the value must be a number"),n=null)):"double"===i?(n=parseFloat(n),!isNaN(n)&&isFinite(n)||(t.log("ignoring "+e+": the value is not double"),n=null)):"boolean"===i&&("true"===i||"1"===i?n=!0:"false"===i||"0"===i?n=!1:(t.log("ignoring "+e+": the value is not boolean"),n=null)),n};R.prototype.logInlinedEvent=function(t,e,n){for(var i=e||{},o=function(t){if(document.querySelectorAll)return document.querySelectorAll("[rakam-event-attribute]");for(var e=[],n=document.getElementsByTagName("*"),i=0,o=n.length;i<o;i++)null!==n[i].getAttribute(t)&&e.push(n[i]);return e}("rakam-event-attribute"),s=0;s<o.length;s++){var r=o[s],a=r.getAttribute("rakam-event-attribute"),u=r.getAttribute("rakam-event-attribute-value"),d=r.getAttribute("rakam-event-attribute-type");if(null===u)if("INPUT"===r.tagName)u=r.value;else if("SELECT"===r.tagName){var p=r.options[r.selectedIndex];if(null!==p.value&&""!==p.value){u="value"!==r.getAttribute("rakam-attribute-value")?p.value:p.text}}else r.innerText?u=r.innerText.replace(/^\s+|\s+$/g,""):this.log("Could find value of DOM element.",r);null!==u&&""!==u&&(i[a]=q(this,a,u,d))}this.logEvent(t,i,n)},R.prototype.isReturningUser=function(){return this._returningUser};var L,B=0,F=(new Date).getTime();R.prototype.startTimer=function(t){if(F=(new Date).getTime(),x.on("idle",function(){L=(new Date).getTime()}),x.on("wakeup",function(){B+=(new Date).getTime()-L,L=null}),t){var e;null!==window.onbeforeunload&&(e=window.onbeforeunload);var n=this;window.onbeforeunload=function(t){c.set("_rakam_time",n.getTimeOnPage()),e&&e(t)}}},R.prototype.getTimeOnPage=function(){return((L>0?L:(new Date).getTime())-F-B)/1e3},R.prototype.getTimeOnPreviousPage=function(){return c.get("_rakam_time")},R.prototype.nextEventId=function(){return this._eventId++,this._eventId},R.prototype._sendEventsIfReady=function(t){return 0!==this._unsentEvents.length&&(this.options.batchEvents?this._unsentEvents.length>=this.options.eventUploadThreshold?(this.sendEvents(t),!0):(setTimeout(this.sendEvents.bind(this),this.options.eventUploadPeriodMillis),!1):(this.sendEvents(t),!0))};var z=function(t){var e=c.get(t.options.cookieName);e&&(e.deviceId&&(t.options.deviceId=e.deviceId),e.userId&&(t.options.userId=e.userId),e.superProps&&(t.options.superProperties=e.superProps),void 0!==e.optOut&&(t.options.optOut=e.optOut),void 0!==e.deviceIdCreatedAt&&(t.deviceIdCreatedAt=new Date(parseInt(e.deviceIdCreatedAt))))},K=function(t){c.set(t.options.cookieName,{deviceId:t.options.deviceId,deviceIdCreatedAt:t.deviceIdCreatedAt?t.deviceIdCreatedAt.getTime():void 0,userId:t.options.userId,superProps:t.options.superProperties,optOut:t.options.optOut})};R._getUtmParam=function(t,e){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var n=new RegExp("[\\?&]"+t+"=([^&#]*)").exec(e);return null===n?void 0:decodeURIComponent(n[1].replace(/\+/g," "))},R._getUtmData=function(t,e){var n=t?"?"+t.split(".").slice(-1)[0].replace(/\|/g,"&"):"",i=function(t,e,n,i){return R._getUtmParam(t,e)||R._getUtmParam(n,i)};return{utm_source:i("utm_source",e,"utmcsr",n),utm_medium:i("utm_medium",e,"utmcmd",n),utm_campaign:i("utm_campaign",e,"utmccn",n),utm_term:i("utm_term",e,"utmctr",n),utm_content:i("utm_content",e,"utmcct",n)}},R.prototype._initUtmData=function(t,e){t=t||location.search,e=e||c.get("__utmz"),this._utmProperties=R._getUtmData(e,t)},R.prototype._initTrackForms=function(){var e=this;document.addEventListener("submit",function(n){var i=n.target||n.srcElement,o=i.getAttribute("rakam-event-form");if("FORM"===i.tagName&&o){var s={},r=i.getAttribute("rakam-event-extra");if(null!==r)for(var a in t.parse(r))r.hasOwnProperty(a)&&(s[a]=r[a]);for(var u=0;u<i.elements.length;u++){var d,p=i.elements[u],l=p.getAttribute("rakam-event-attribute-type");if(p.hasAttribute("type")&&(d=p.getAttribute("type").toLowerCase()),"password"!==d&&(null===l&&"INPUT"===p.tagName&&"number"===d&&(l="long"),!p.hasAttribute("rakam-event-form-element-ignore"))){var c;c=p.hasAttribute("rakam-event-attribute")?p.getAttribute("rakam-event-attribute"):p.getAttribute("name"),p.hasAttribute("rakam-event-attribute-value")?s[c]=q(this,c,p.getAttribute("rakam-event-attribute-value"),l):"SELECT"===p.tagName?s[c]=q(this,c,p.options[p.selectedIndex].value,l):"INPUT"===p.tagName||"TEXTAREA"===p.tagName?s[c]=q(this,c,p.value,l):e.log("Couldn't get value of form element: "+c)}}e.logEvent(o,s)}})},R.prototype._initTrackClicks=function(){var e=this;document.addEventListener("click",function(n){var i=n.target||n.srcElement,o=i.getAttribute("rakam-event-track");if(o){var s={},r=i.getAttribute("rakam-event-properties");if(null!==r)for(var a in t.parse(r))r.hasOwnProperty(a)&&(s[a]=r[a]);e.logEvent(o,s)}})},R.prototype.saveEvents=function(){try{m.setItem(this.options.unsentKey,t.stringify(this._unsentEvents))}catch(t){this.log(t)}},R.prototype.setDomain=function(t){try{c.options({domain:t}),this.options.domain=c.options().domain,z(this),K(this),this.log("set domain="+t)}catch(t){this.log(t)}},R.prototype.setUserId=function(t){try{var e=this.options.deviceId;if(this.options.userId=void 0!==t&&null!==t&&""+t||null,null!==t&&""!==t&&void 0!==t&&(this._eventId>0&&(null===e||void 0===e)||null!==e&&void 0!==e)){var n=this;this.User()._merge(e,this.deviceIdCreatedAt,function(){n.deviceIdCreatedAt=null,K(n)})}K(this),this.log("set userId="+t)}catch(t){this.log(t)}},R.prototype.setUserProperties=function(t){try{return(new this.User).set(t)}catch(t){this.log(t)}},R.prototype.getUserId=function(){return this.options.userId},R.prototype.getDeviceId=function(){return this._eventId>0?this.options.deviceId:null},R.prototype.setOptOut=function(t){try{this.options.optOut=t,K(this),this.log("set optOut="+t)}catch(t){this.log(t)}},R.prototype.setDeviceId=function(t){try{t&&(this.options.deviceId=""+t,K(this))}catch(t){this.log(t)}},R.prototype.setSuperProperties=function(e,n){try{this.options.superProperties=this.options.superProperties||{};for(var i in e)if(e.hasOwnProperty(i)){if(!1===n&&void 0!==this.options.superProperties[i])continue;this.options.superProperties[i]=e[i]}K(this),this.log("set super properties="+t.stringify(e))}catch(t){this.log(t)}},R.prototype.setVersionName=function(t){try{this.options.versionName=t,this.log("set versionName="+t)}catch(t){this.log(t)}},R.prototype._logEvent=function(e,n,i,o){if("function"!=typeof o&&(o=null),e&&!this.options.optOut)try{var s=(new Date).getTime(),r=this.nextEventId();(!this._sessionId||!this._lastEventTime||s-this._lastEventTime>this.options.sessionTimeout)&&(this._sessionId=s,m.setItem(N,this._sessionId)),this._lastEventTime=s,m.setItem(D,this._lastEventTime),m.setItem(O,r),i=i||{},g(n=n||{},this._utmProperties);var a={collection:e,properties:{_device_id:this.options.deviceId,_user:this.options.userId,_time:1e3*parseInt(s/1e3),_session_id:this._sessionId||-1,_platform:this.options.platform,_language:this.options.language}};return g(a.properties,this.options.superProperties),g(a.properties,i),g(a.properties,n),this.log("logged eventType="+e+", properties="+t.stringify(n)),this._unsentEvents.push({id:r,event:a}),this._unsentEvents.length>this.options.savedMaxCount&&this._unsentEvents.splice(0,this._unsentEvents.length-this.options.savedMaxCount),this.options.saveEvents&&this.saveEvents(),!this._sendEventsIfReady(o)&&o&&o(0,"No request sent"),r}catch(t){this.log(t)}else o&&o(0,"No request sent")},R.prototype.logEvent=function(t,e,n){return this._logEvent(t,e,null,n)},R.prototype.removeEvents=function(t,e){for(var n=[],i=e||[],o=0;o<this._unsentEvents.length;o++){var s=this._unsentEvents[o].id;(i.indexOf(s)>-1||s>t)&&n.push(this._unsentEvents[o])}this._unsentEvents=n},R.prototype.sendEvents=function(e){var n=this;if(!this._sending&&!this.options.optOut&&this._unsentEvents.length>0){this._sending=!0;var i=("https:"===window.location.protocol?"https":"http")+"://"+this.options.apiEndpoint+this.options.eventEndpointPath,o=Math.min(this._unsentEvents.length,this.options.uploadBatchSize),s=this._unsentEvents[o-1].id;this._unsentEvents.slice(0,o);var r=this._unsentEvents.slice(0,o).map(function(t){return t.event}),a={upload_time:(new Date).getTime(),api_version:1,api_key:this.options.apiKey},u=this;new _(i,{api:a,events:r}).send(function(i,r,a){u._sending=!1;try{200===i||409===i?(n.log("successful upload"),u.removeEvents(s,409===i?t.parse(r):null),u.options.saveEvents&&u.saveEvents(),!u._sendEventsIfReady(e)&&e&&e(i,r)):413===i?(n.log("request too large"),1===u.options.uploadBatchSize&&u.removeEvents(s),u.options.uploadBatchSize=Math.ceil(o/2),u.sendEvents(e)):e&&e(i,r)}catch(t){n.log("failed upload")}if(u.options.eventCallbacks)try{for(var d=0;d<u.options.eventCallbacks.length;d++)u.options.eventCallbacks[d](i,r,a)}catch(t){n.log("callback throws an exception",t)}})}else e&&e(0,"No request sent")},R.prototype.onload=function(t){var e=this;setTimeout(function(){t(),e.log("executed callback",t)},1)},R.prototype.runQueuedFunctions=function(){for(var t=0;t<this._q.length;t++){var e=this[this._q[t][0]];e&&"function"===P(e)&&e.apply(this,this._q[t].slice(1))}this._q=[]},R.prototype.__VERSION__=",";var j=R,H=window.rakam||{},X=new j;X._q=H._q||[];return X});
